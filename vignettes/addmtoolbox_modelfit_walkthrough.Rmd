---
title: "addmtoolbox: modelfit walkthrough"
author: "Alexander Fengler"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{addmtoolbox: modelfit walkthrough}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
---

### Intro

This vignette illustrates the process of fitting (attentional) drift diffusion models to experimental choice and reaction time data (and fixation data). We are going to walk through a model fit that is done *by unique experiment condition* using only the functionality provided by the ***addmtoolbox*** package in ***R***.

As example data we are goint to use the two data frames that come supplied by the package: 

1. `addm_data_choice` 
2. `addm_data_eye`

### Load Environment

Before starting lets load the necessary environment for working with the ***addmtoolbox***.

```{r, message=FALSE, warning=FALSE}
library("addmtoolbox")
```

The package is selfcontained in that it should load all dependencies correctly, and you are good to go now. <br><br><br> 

# Data Preparation

## The Data Frames

Lets first have a quick look at the content of the two data frames that are supplied with the package.

### Choice Data

```{r, results='hide'}
# Lets look at the choice data 
head(addm_data_choice)
```

```{r, results = "asis", echo=FALSE}
pander::pandoc.table(head(addm_data_choice))
```
We can see that `addm_data_choice` has **five** columns. 

- **id** which provides a unique key per observed trial
- **v1** providing the valuation of the left item on the screen
- **v2** providing the valuation of the right item on the screen
- **decision** providing the decision taken in a specific trial (1 = left, 2 = right)
- **rt** the reaction time in a given trial

### Fixation Data

```{r, results='hide'}
  # Lets look at the choice data 
  head(addm_data_eye)
```

```{r, results = "asis", echo=FALSE}
  pander::pandoc.table(head(addm_data_eye))
```

We can see that `addm_data_eye` has **four** columns.

- **fixloc** the fixation location of a given fixation (coded as referring to item attended)
- **fixdur** the duration of a given fixation
- **fixnr** the within trial number of a fixation
- **id** a unique trial identifier that **importantly** matches the id of `addm_data_choice`

## Pre Processing 

The two **data.frames** supplied in the ***addmtoolbox*** package serve as an illustration of the structure that is expected for the package to be conveniently usable.

Once our data is in shape we can continue to use the `addm_dataprep()` function, like so:

```{r, results='hide'}
 our.dat = addm_dataprep(choice.dat = addm_data_choice,
                         eye.dat = addm_data_eye,
                         timestep = 10,
                         rtbinsize = 100,
                         fit.type = 'condition')  
```

Lets quickly go through the arguments that need to be supplied to `addm_dataprep()`:    

- `choice.dat` and `eye.dat` refer trivially to two **data.frames** (**data.tables**) in the exact shape as our example **data.frames**.      
- `timestep` refers to the size of timesteps that you would like to apply in your model fit (in milliseconds). We need to supply this for our data preparation, because fixation times and reaction times will be rounded according to the timestep-size applied for model simulations.      
- `rtbinsize` is needed to bin our reaction-time data (in milliseconds). `addm_dataprep()` will take over this binning for you and makes sure the data is in a format that these bins will be consistently applied for the rest of the modelling process.       
- Lastly, we need to supply a `fit.type`. Two fit types are currently implemented. `"condition"` and `"trial"` which refer simply to fitting of the model by trial, or by unique trial conditions. Dependent on what you supply here, the `addm_dataprep()` will return different output.   

For `fit.type = "condition"` the return value is a list of two elements.     

1. **conditions.dat**
2. **choice.dat**    

For `fit.type ="trial"` the return value is a list of two elements.    

1. **choice.dat**
2. **eye.dat**    

When **fitting by condition**, the model will assume that you are providing a fixation model yourself, and therefore does not need a separate eyetracking dataframe. Therefore we have no element for eyetracking data in the returned list    

When **fitting by trial**, the model needs empirical eyetracking data by trial, however a data.frame providing information about unique conditions is obsolete. Therefore we have a return element for eyetracking data, but none for conditions. 

Lets look at the output that we have generated with out call to `addm_dataprep()`:

```{r, echo=FALSE}
 our.dat
```

**Note**, that the id variable has changed from the one we originally supplied, to an identifier for unique trial conditions. A simple rule is applied here. The values that appear in every trial display are simply concatenated as a string and separated by "_". 

***Important***
---------

`addm_dataprep()` expects you to supply an id-variable that is a unique identifier of each trial for each subject (that means that trial 1 for subject 1 has a different key than trial 1 for subject 2). Note, that row.numbers are not sufficient, because **consistency** is demanded between ***trial-identifiers of the choice data.frame*** and ***trial-identifiers of the eye data.frame***.    

When you choose to fit by **condition**, it is important to note that `addm_dataprep()` is actually ***changing the trial-identifiers for you into condition identifiers***. STILL, `addm_dataprep()` expects you to supply the data with identifiers by trial first.

# Fitting the model

Now that our data is prepared for usage with the main functions of the ***addmtoolbox** package, we can call the `addm_fit_grid()` function.

```{r}
 addm_fit_grid
 
```


